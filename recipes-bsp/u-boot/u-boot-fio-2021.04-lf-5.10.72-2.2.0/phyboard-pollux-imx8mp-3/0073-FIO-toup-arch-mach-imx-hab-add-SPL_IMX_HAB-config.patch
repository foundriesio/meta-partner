From 0438a773a74ea963a226325da40f1b76f5985df9 Mon Sep 17 00:00:00 2001
From: Michael Scott <mike@foundries.io>
Date: Wed, 16 Dec 2020 17:43:18 -0800
Subject: [PATCH 073/322] [FIO toup] arch: mach-imx: hab: add SPL_IMX_HAB
 config

This allows granularity of turning off HAB features for SPL
which might not need them.

Signed-off-by: Michael Scott <mike@foundries.io>
---
 arch/arm/mach-imx/Kconfig  | 8 ++++++++
 arch/arm/mach-imx/Makefile | 8 ++++----
 arch/arm/mach-imx/spl.c    | 2 +-
 3 files changed, 13 insertions(+), 5 deletions(-)

diff --git a/arch/arm/mach-imx/Kconfig b/arch/arm/mach-imx/Kconfig
index 546afffeeb2..b3eddef4f90 100644
--- a/arch/arm/mach-imx/Kconfig
+++ b/arch/arm/mach-imx/Kconfig
@@ -79,6 +79,14 @@ config IMX_HAB
 	  This option enables the support for secure boot (HAB).
 	  See doc/imx/habv4/* for more details.
 
+config SPL_IMX_HAB
+	bool "Support i.MX HAB features in SPL"
+	default y if IMX_HAB
+	depends on ARCH_MX7 || ARCH_MX6 || ARCH_MX5 || ARCH_MX7ULP || ARCH_IMX8M
+	help
+	  This option enables the support for secure boot (HAB) in SPL.
+	  See doc/README.mxc_hab for more details.
+
 config CSF_SIZE
 	hex "Maximum size for Command Sequence File (CSF) binary"
 	depends on IMX_HAB
diff --git a/arch/arm/mach-imx/Makefile b/arch/arm/mach-imx/Makefile
index 74ba0d9ba9c..af9f6792957 100644
--- a/arch/arm/mach-imx/Makefile
+++ b/arch/arm/mach-imx/Makefile
@@ -18,7 +18,7 @@ obj-y += mmc_env.o
 obj-$(CONFIG_FEC_MXC) += mac.o
 obj-$(CONFIG_DWC_ETH_QOS) += mac.o
 obj-$(CONFIG_SYS_I2C_MXC) += i2c-mxv7.o
-obj-$(CONFIG_IMX_HAB) += hab.o
+obj-$(CONFIG_$(SPL_)IMX_HAB) += hab.o
 obj-y += cpu.o
 obj-y += mmdc_size.o
 endif
@@ -60,16 +60,16 @@ ifneq ($(CONFIG_SPL_BUILD),y)
 obj-$(CONFIG_IMX_BOOTAUX) += imx_bootaux.o
 endif
 obj-$(CONFIG_SATA) += sata.o
-obj-$(CONFIG_IMX_HAB)    += hab.o
+obj-$(CONFIG_$(SPL_)IMX_HAB)    += hab.o
 obj-$(CONFIG_SYSCOUNTER_TIMER) += syscounter.o
 obj-$(CONFIG_IMX_TRUSTY_OS) += trusty.o
 endif
 ifeq ($(SOC),$(filter $(SOC),mx7ulp))
 obj-y  += cache.o mmdc_size.o
-obj-$(CONFIG_IMX_HAB) += hab.o
+obj-$(CONFIG_$(SPL_)IMX_HAB) += hab.o
 endif
 ifeq ($(SOC),$(filter $(SOC),mx6 mx7ulp))
-obj-$(CONFIG_IMX_HAB) += fiohab.o
+obj-$(CONFIG_$(SPL_)IMX_HAB) += fiohab.o
 endif
 ifeq ($(SOC),$(filter $(SOC),vf610))
 obj-y += ddrmc-vf610.o
diff --git a/arch/arm/mach-imx/spl.c b/arch/arm/mach-imx/spl.c
index 5ad4d0b6f41..48887de7e74 100644
--- a/arch/arm/mach-imx/spl.c
+++ b/arch/arm/mach-imx/spl.c
@@ -257,7 +257,7 @@ u32 spl_mmc_boot_mode(const u32 boot_device)
 }
 #endif
 
-#if defined(CONFIG_IMX_HAB)
+#if defined(CONFIG_SPL_IMX_HAB)
 
 /*
  * +------------+  0x0 (DDR_UIMAGE_START) -
-- 
2.34.1

