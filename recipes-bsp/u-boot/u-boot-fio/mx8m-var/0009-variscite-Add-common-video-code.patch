From bf7822775f22ee2f30e98dc474885e60b9bf208c Mon Sep 17 00:00:00 2001
From: Felix Radensky <felix.r@variscite.com>
Date: Wed, 4 Aug 2021 10:49:33 +0300
Subject: [PATCH] variscite: Add common video code

(cherry picked from commit 56a8d1dfc30d68866949ff8632d6fb9c6519c967)
---
 board/variscite/common/video.c | 68 ++++++++++++++++++++++++++++++++++
 1 file changed, 68 insertions(+)
 create mode 100644 board/variscite/common/video.c

diff --git a/board/variscite/common/video.c b/board/variscite/common/video.c
new file mode 100644
index 00000000000..7ec6aeb5c58
--- /dev/null
+++ b/board/variscite/common/video.c
@@ -0,0 +1,68 @@
+/*
+ * Copyright (C) 2016 Freescale Semiconductor, Inc.
+ * Copyright 2018 NXP
+ *
+ * SPDX-License-Identifier:	GPL-2.0+
+ */
+
+#include <common.h>
+#include <splash.h>
+#include <mmc.h>
+
+#ifdef CONFIG_SPLASH_SCREEN
+static int check_env(char *var, char *val)
+{
+	char *env_val = env_get(var);
+
+	if ((env_val != NULL) &&
+		(strcmp(env_val, val) == 0)) {
+		return 1;
+	}
+
+	return 0;
+}
+
+static void splash_set_source(void)
+{
+	if (!check_env("splashsourceauto", "yes"))
+		return;
+
+	if (mmc_get_env_dev() == 0)
+		env_set("splashsource", "emmc");
+	else if (mmc_get_env_dev() == 1)
+		env_set("splashsource", "sd");
+}
+
+int splash_screen_prepare(void)
+{
+	char sd_devpart[5];
+	char emmc_devpart[5];
+	u32 sd_part, emmc_part;
+
+	sd_part = emmc_part = env_get_ulong("mmcpart", 10, 0);
+
+	sprintf(sd_devpart, "1:%d", sd_part);
+	sprintf(emmc_devpart, "0:%d", emmc_part);
+
+	struct splash_location splash_locations[] = {
+		{
+			.name = "sd",
+			.storage = SPLASH_STORAGE_MMC,
+			.flags = SPLASH_STORAGE_FS,
+			.devpart = sd_devpart,
+		},
+		{
+			.name = "emmc",
+			.storage = SPLASH_STORAGE_MMC,
+			.flags = SPLASH_STORAGE_FS,
+			.devpart = emmc_devpart,
+		}
+	};
+
+	splash_set_source();
+
+	return splash_source_load(splash_locations,
+			ARRAY_SIZE(splash_locations));
+
+}
+#endif
-- 
2.34.1

