From d9e1753bc8e2848930b547b511da7aea9a760d40 Mon Sep 17 00:00:00 2001
From: Mohit Singh <mohit.p@variscite.com>
Date: Thu, 27 Aug 2020 17:53:30 -0700
Subject: [PATCH 02/11] imx8mn_var_som: Add support for Android-10.0.0_2.3.0

---
 .../variscite/imx8mn_var_som/imx8mn_var_som.c |   9 ++
 configs/imx8mn_var_som_android_defconfig      | 107 ++++++++++++++++++
 configs/imx8mn_var_som_android_uuu_defconfig  | 104 +++++++++++++++++
 include/configs/imx8mn_var_som.h              |   4 +
 include/configs/imx8mn_var_som_android.h      |  93 +++++++++++++++
 5 files changed, 317 insertions(+)
 create mode 100644 configs/imx8mn_var_som_android_defconfig
 create mode 100644 configs/imx8mn_var_som_android_uuu_defconfig
 create mode 100644 include/configs/imx8mn_var_som_android.h

diff --git a/board/variscite/imx8mn_var_som/imx8mn_var_som.c b/board/variscite/imx8mn_var_som/imx8mn_var_som.c
index 7d26ace948..4bcc9b6381 100644
--- a/board/variscite/imx8mn_var_som/imx8mn_var_som.c
+++ b/board/variscite/imx8mn_var_som/imx8mn_var_som.c
@@ -156,3 +156,12 @@ int board_late_init(void)
 
 	return 0;
 }
+
+#ifdef CONFIG_FSL_FASTBOOT
+#ifdef CONFIG_ANDROID_RECOVERY
+int is_recovery_key_pressing(void)
+{
+       return 0; /*TODO*/
+}
+#endif /*CONFIG_ANDROID_RECOVERY*/
+#endif /*CONFIG_FSL_FASTBOOT*/
diff --git a/configs/imx8mn_var_som_android_defconfig b/configs/imx8mn_var_som_android_defconfig
new file mode 100644
index 0000000000..eb8f03bee3
--- /dev/null
+++ b/configs/imx8mn_var_som_android_defconfig
@@ -0,0 +1,107 @@
+CONFIG_ARM=y
+CONFIG_SPL_SYS_ICACHE_OFF=y
+CONFIG_SPL_SYS_DCACHE_OFF=y
+CONFIG_ARCH_IMX8M=y
+CONFIG_SYS_TEXT_BASE=0x40200000
+CONFIG_ENV_SIZE=0x1000
+CONFIG_ENV_OFFSET=0x400000
+CONFIG_DM_GPIO=y
+CONFIG_SPL_MMC_SUPPORT=y
+CONFIG_SPL_SERIAL_SUPPORT=y
+CONFIG_SPL_LIBCOMMON_SUPPORT=y
+CONFIG_SPL_LIBGENERIC_SUPPORT=y
+CONFIG_NR_DRAM_BANKS=1
+CONFIG_TARGET_IMX8MN_VAR_SOM=y
+CONFIG_SPL=y
+CONFIG_SPL_IMX_ROMAPI_LOADADDR=0x48000000
+CONFIG_SPL_TEXT_BASE=0x912000
+CONFIG_FIT=y
+CONFIG_FIT_EXTERNAL_OFFSET=0x3000
+CONFIG_SPL_LOAD_FIT=y
+CONFIG_SPL_FIT_GENERATOR="arch/arm/mach-imx/mkimage_fit_atf.sh"
+CONFIG_SYS_EXTRA_OPTIONS="IMX_CONFIG=arch/arm/mach-imx/imx8m/imximage-8mn-ddr4.cfg, ANDROID_SUPPORT"
+CONFIG_ENV_IS_NOWHERE=y
+CONFIG_BOOTDELAY=1
+CONFIG_DEFAULT_FDT_FILE="imx8mn-var-som.dtb"
+CONFIG_ARCH_MISC_INIT=y
+CONFIG_SPL_BOARD_INIT=y
+CONFIG_SPL_BOOTROM_SUPPORT=y
+CONFIG_SPL_SEPARATE_BSS=y
+CONFIG_SPL_USB_HOST_SUPPORT=y
+CONFIG_SPL_USB_GADGET=y
+CONFIG_SPL_USB_SDP_SUPPORT=y
+CONFIG_HUSH_PARSER=y
+CONFIG_FASTBOOT=y
+CONFIG_FASTBOOT_LOCK=y
+CONFIG_FSL_FASTBOOT=y
+CONFIG_FS_FAT=y
+CONFIG_EFI_PARTITION=y
+CONFIG_CMD_EXT2=y
+CONFIG_CMD_EXT4=y
+CONFIG_CMD_EXT4_WRITE=y
+CONFIG_CMD_FAT=y
+CONFIG_CMD_GPIO=y
+CONFIG_CMD_I2C=y
+CONFIG_CMD_CACHE=y
+CONFIG_CMD_REGULATOR=y
+CONFIG_CMD_MEMTEST=y
+CONFIG_CMD_CLK=y
+CONFIG_OF_CONTROL=y
+CONFIG_DEFAULT_DEVICE_TREE="imx8mn-var-som"
+CONFIG_ENV_IS_IN_MMC=y
+CONFIG_SYS_RELOC_GD_ENV_ADDR=y
+CONFIG_NET_RANDOM_ETHADDR=y
+CONFIG_REGMAP=y
+CONFIG_SYSCON=y
+CONFIG_CLK_COMPOSITE_CCF=y
+CONFIG_CLK_IMX8MN=y
+CONFIG_USB_FUNCTION_FASTBOOT=y
+CONFIG_CMD_FASTBOOT=y
+CONFIG_ANDROID_BOOT_IMAGE=y
+CONFIG_FASTBOOT_UUU_SUPPORT=n
+CONFIG_FASTBOOT_BUF_ADDR=0x44800000
+CONFIG_FASTBOOT_BUF_SIZE=0x19000000
+CONFIG_FASTBOOT_FLASH=y
+CONFIG_DM_I2C=y
+CONFIG_SYS_I2C_MXC=y
+CONFIG_DM_MMC=y
+CONFIG_MMC_IO_VOLTAGE=y
+CONFIG_MMC_UHS_SUPPORT=y
+CONFIG_MMC_HS400_ES_SUPPORT=y
+CONFIG_MMC_HS400_SUPPORT=y
+CONFIG_DM_ETH=y
+CONFIG_FEC_MXC=y
+CONFIG_PINCTRL=y
+CONFIG_PINCTRL_IMX8M=y
+CONFIG_DM_REGULATOR=y
+CONFIG_DM_REGULATOR_FIXED=y
+CONFIG_DM_REGULATOR_GPIO=y
+CONFIG_DM_RESET=y
+CONFIG_SYSRESET=y
+CONFIG_SYSRESET_PSCI=y
+CONFIG_DM_THERMAL=y
+CONFIG_NXP_TMU=y
+CONFIG_CMD_BOOTA=y
+CONFIG_SUPPORT_RAW_INITRD=y
+CONFIG_USB=y
+CONFIG_DM_USB=y
+CONFIG_USB_EHCI_HCD=y
+CONFIG_USB_GADGET=y
+CONFIG_USB_GADGET_MANUFACTURER="Variscite"
+CONFIG_USB_GADGET_VENDOR_NUM=0x0525
+CONFIG_USB_GADGET_PRODUCT_NUM=0xa4a5
+CONFIG_USB_GADGET_DOWNLOAD=y
+CONFIG_APPEND_BOOTARGS=y
+CONFIG_LZ4=y
+CONFIG_ANDROID_RECOVERY=y
+CONFIG_LIBAVB=y
+CONFIG_AVB_SUPPORT=y
+CONFIG_DM_VIDEO=y
+CONFIG_CMD_BMP=y
+CONFIG_REGEX=n
+CONFIG_CI_UDC=y
+CONFIG_OF_LIBFDT_OVERLAY=y
+CONFIG_AVB_WARNING_LOGO=y
+CONFIG_AVB_WARNING_LOGO_COLS=0x320
+CONFIG_AVB_WARNING_LOGO_ROWS=0xc0
+CONFIG_BCB_SUPPORT=y
diff --git a/configs/imx8mn_var_som_android_uuu_defconfig b/configs/imx8mn_var_som_android_uuu_defconfig
new file mode 100644
index 0000000000..9fcc4dbeb0
--- /dev/null
+++ b/configs/imx8mn_var_som_android_uuu_defconfig
@@ -0,0 +1,104 @@
+CONFIG_ARM=y
+CONFIG_SPL_SYS_ICACHE_OFF=y
+CONFIG_SPL_SYS_DCACHE_OFF=y
+CONFIG_ARCH_IMX8M=y
+CONFIG_SYS_TEXT_BASE=0x40200000
+CONFIG_ENV_SIZE=0x1000
+CONFIG_ENV_OFFSET=0x400000
+CONFIG_DM_GPIO=y
+CONFIG_SPL_MMC_SUPPORT=y
+CONFIG_SPL_SERIAL_SUPPORT=y
+CONFIG_SPL_LIBCOMMON_SUPPORT=y
+CONFIG_SPL_LIBGENERIC_SUPPORT=y
+CONFIG_NR_DRAM_BANKS=1
+CONFIG_TARGET_IMX8MN_VAR_SOM=y
+CONFIG_SPL=y
+CONFIG_SPL_IMX_ROMAPI_LOADADDR=0x48000000
+CONFIG_SPL_TEXT_BASE=0x912000
+CONFIG_FIT=y
+CONFIG_FIT_EXTERNAL_OFFSET=0x3000
+CONFIG_SPL_LOAD_FIT=y
+CONFIG_SPL_FIT_GENERATOR="arch/arm/mach-imx/mkimage_fit_atf.sh"
+CONFIG_SYS_EXTRA_OPTIONS="IMX_CONFIG=arch/arm/mach-imx/imx8m/imximage-8mn-ddr4.cfg, ANDROID_SUPPORT"
+CONFIG_ENV_IS_NOWHERE=y
+CONFIG_BOOTDELAY=1
+CONFIG_DEFAULT_FDT_FILE="imx8mn-var-som.dtb"
+CONFIG_ARCH_MISC_INIT=y
+CONFIG_SPL_BOARD_INIT=y
+CONFIG_SPL_BOOTROM_SUPPORT=y
+CONFIG_SPL_SEPARATE_BSS=y
+CONFIG_SPL_USB_HOST_SUPPORT=y
+CONFIG_SPL_USB_GADGET=y
+CONFIG_SPL_USB_SDP_SUPPORT=y
+CONFIG_HUSH_PARSER=y
+CONFIG_FASTBOOT=y
+CONFIG_FASTBOOT_LOCK=y
+CONFIG_FASTBOOT_UUU_SUPPORT=y
+CONFIG_FSL_FASTBOOT=y
+CONFIG_FS_FAT=y
+CONFIG_EFI_PARTITION=y
+CONFIG_CMD_EXT2=y
+CONFIG_CMD_EXT4=y
+CONFIG_CMD_EXT4_WRITE=y
+CONFIG_CMD_FAT=y
+CONFIG_CMD_GPIO=y
+CONFIG_CMD_I2C=y
+CONFIG_CMD_CACHE=y
+CONFIG_CMD_REGULATOR=y
+CONFIG_CMD_MEMTEST=y
+CONFIG_CMD_CLK=y
+CONFIG_OF_CONTROL=y
+CONFIG_DEFAULT_DEVICE_TREE="imx8mn-var-som"
+CONFIG_ENV_IS_IN_MMC=y
+CONFIG_SYS_RELOC_GD_ENV_ADDR=y
+CONFIG_NET_RANDOM_ETHADDR=y
+CONFIG_CLK_COMPOSITE_CCF=y
+CONFIG_CLK_IMX8MN=y
+CONFIG_USB_FUNCTION_FASTBOOT=y
+CONFIG_CMD_FASTBOOT=y
+CONFIG_ANDROID_BOOT_IMAGE=y
+CONFIG_FASTBOOT_BUF_ADDR=0x44800000
+CONFIG_FASTBOOT_BUF_SIZE=0x19000000
+CONFIG_FASTBOOT_FLASH=y
+CONFIG_DM_I2C=y
+CONFIG_SYS_I2C_MXC=y
+CONFIG_DM_MMC=y
+CONFIG_MMC_IO_VOLTAGE=y
+CONFIG_MMC_UHS_SUPPORT=y
+CONFIG_MMC_HS400_ES_SUPPORT=y
+CONFIG_MMC_HS400_SUPPORT=y
+CONFIG_DM_ETH=y
+CONFIG_FEC_MXC=y
+CONFIG_PINCTRL=y
+CONFIG_PINCTRL_IMX8M=y
+CONFIG_DM_REGULATOR=y
+CONFIG_DM_REGULATOR_FIXED=y
+CONFIG_DM_REGULATOR_GPIO=y
+CONFIG_SYSRESET=y
+CONFIG_SYSRESET_PSCI=y
+CONFIG_DM_THERMAL=y
+CONFIG_NXP_TMU=y
+CONFIG_CMD_BOOTA=y
+CONFIG_SUPPORT_RAW_INITRD=y
+CONFIG_USB=y
+CONFIG_DM_USB=y
+CONFIG_USB_EHCI_HCD=y
+CONFIG_USB_GADGET=y
+CONFIG_USB_GADGET_MANUFACTURER="Variscite"
+CONFIG_USB_GADGET_VENDOR_NUM=0x0525
+CONFIG_USB_GADGET_PRODUCT_NUM=0xa4a5
+CONFIG_USB_GADGET_DOWNLOAD=y
+CONFIG_APPEND_BOOTARGS=y
+CONFIG_LZ4=y
+CONFIG_ANDROID_RECOVERY=y
+CONFIG_LIBAVB=y
+CONFIG_AVB_SUPPORT=y
+CONFIG_DM_VIDEO=y
+CONFIG_CMD_BMP=y
+CONFIG_REGEX=n
+CONFIG_CI_UDC=y
+CONFIG_OF_LIBFDT_OVERLAY=y
+CONFIG_AVB_WARNING_LOGO=y
+CONFIG_AVB_WARNING_LOGO_COLS=0x320
+CONFIG_AVB_WARNING_LOGO_ROWS=0xc0
+CONFIG_BCB_SUPPORT=y
diff --git a/include/configs/imx8mn_var_som.h b/include/configs/imx8mn_var_som.h
index eecb6545ce..c554a9da63 100644
--- a/include/configs/imx8mn_var_som.h
+++ b/include/configs/imx8mn_var_som.h
@@ -310,4 +310,8 @@
 
 #define CONFIG_OF_SYSTEM_SETUP
 
+#if defined(CONFIG_ANDROID_SUPPORT)
+#include "imx8mn_var_som_android.h"
+#endif
+
 #endif
diff --git a/include/configs/imx8mn_var_som_android.h b/include/configs/imx8mn_var_som_android.h
new file mode 100644
index 0000000000..c874d54c6b
--- /dev/null
+++ b/include/configs/imx8mn_var_som_android.h
@@ -0,0 +1,93 @@
+/*
+ * Copyright 2018 NXP
+ *
+ * SPDX-License-Identifier:	GPL-2.0+
+ */
+
+#ifndef IMX8MN_VAR_SOM_ANDROID_H
+#define IMX8MN_VAR_SOM_ANDROID_H
+
+#define CONFIG_ANDROID_AB_SUPPORT
+#ifdef CONFIG_ANDROID_AB_SUPPORT
+#define CONFIG_SYSTEM_RAMDISK_SUPPORT
+#endif
+#define FSL_FASTBOOT_FB_DEV "mmc"
+
+#ifdef CONFIG_SYS_MALLOC_LEN
+#undef CONFIG_SYS_MALLOC_LEN
+#define CONFIG_SYS_MALLOC_LEN           (96 * SZ_1M)
+#endif
+
+#if defined CONFIG_SYS_BOOT_SATA
+#define CONFIG_FASTBOOT_STORAGE_SATA
+#define CONFIG_FASTBOOT_SATA_NO 0
+#endif
+
+
+#undef CONFIG_EXTRA_ENV_SETTINGS
+#undef CONFIG_BOOTCOMMAND
+
+
+#define HW_ENV_SETTINGS \
+	"cmaargs=" \
+		"if test $sdram_size = 1024; then " \
+			"setenv cmavar 320M@0x400M-0xb80M; " \
+		"else " \
+			"setenv cmavar 800M@0x400M-0xb80M; " \
+		"fi; " \
+		"setenv bootargs ${bootargs} " \
+			"cma=${cmavar};\0"
+
+#define BOOT_ENV_SETTINGS \
+	"bootcmd=" \
+		"run cmaargs; " \
+		"boota ${fastboot_dev}\0"
+
+#define CONFIG_EXTRA_ENV_SETTINGS					\
+	HW_ENV_SETTINGS \
+	BOOT_ENV_SETTINGS \
+	"splashpos=m,m\0"	  \
+	"fdt_high=0xffffffffffffffff\0"	  \
+	"initrd_high=0xffffffffffffffff\0" \
+	"panel=NULL\0" \
+	"bootargs=" \
+		"console=ttymxc3,115200 " \
+		"earlycon=ec_imx6q,0x30a60000,115200 " \
+		"init=/init " \
+		"androidboot.console=ttymxc3 " \
+		"consoleblank=0 " \
+		"androidboot.hardware=freescale " \
+		"firmware_class.path=/vendor/firmware " \
+		"loop.max_part=7 " \
+		"androidboot.primary_display=imx-drm " \
+		"galcore.contiguousSize=33554432 " \
+		"androidboot.wificountrycode=US " \
+		"transparent_hugepage=never\0"
+
+
+#if !defined(CONFIG_IMX_TRUSTY_OS) || !defined(CONFIG_DUAL_BOOTLOADER)
+#undef CONFIG_FSL_CAAM_KB
+#endif
+
+#ifdef CONFIG_DUAL_BOOTLOADER
+#define CONFIG_SYS_SPL_PTE_RAM_BASE    0x41580000
+
+#ifdef CONFIG_IMX_TRUSTY_OS
+#define BOOTLOADER_RBIDX_OFFSET  0x3FE000
+#define BOOTLOADER_RBIDX_START   0x3FF000
+#define BOOTLOADER_RBIDX_LEN     0x08
+#define BOOTLOADER_RBIDX_INITVAL 0
+#endif
+
+#endif
+
+#ifdef CONFIG_IMX_TRUSTY_OS
+#define AVB_RPMB
+#define KEYSLOT_HWPARTITION_ID 2
+#define KEYSLOT_BLKS             0x1FFF
+#define NS_ARCH_ARM64 1
+#endif
+
+#define AVB_AB_I_UNDERSTAND_LIBAVB_AB_IS_DEPRECATED
+
+#endif /* IMX8MN_VAR_SOM_ANDROID_H */
-- 
2.35.1

