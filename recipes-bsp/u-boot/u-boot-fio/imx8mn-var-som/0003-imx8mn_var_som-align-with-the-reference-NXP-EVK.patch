From 070976abff09e17d810be2978167ab046b0c8383 Mon Sep 17 00:00:00 2001
From: Diego Dorta <diego.d@variscite.com>
Date: Sat, 25 Feb 2023 11:38:43 -0300
Subject: [PATCH 3/4] imx8mn_var_som: align with the reference NXP EVK

Signed-off-by: Diego Dorta <diego.d@variscite.com>
(cherry picked from commit 6610ad5952d3ba73c61e3074c0a05690042cc0b5)
Signed-off-by: Vanessa Maegima <vanessa.maegima@foundries.io>
---
 .../variscite/imx8mn_var_som/imx8mn_var_som.c  | 18 ++++++++++++++++++
 configs/imx8mn_var_som_defconfig               |  2 +-
 include/configs/imx8mn_var_som.h               |  5 +++--
 3 files changed, 22 insertions(+), 3 deletions(-)

diff --git a/board/variscite/imx8mn_var_som/imx8mn_var_som.c b/board/variscite/imx8mn_var_som/imx8mn_var_som.c
index 4158027f990..d171471564c 100644
--- a/board/variscite/imx8mn_var_som/imx8mn_var_som.c
+++ b/board/variscite/imx8mn_var_som/imx8mn_var_som.c
@@ -6,6 +6,7 @@
  */
 
 #include <common.h>
+#include <efi_loader.h>
 #include <env.h>
 #include <init.h>
 #include <asm/global_data.h>
@@ -45,6 +46,23 @@ static iomux_v3_cfg_t const wdog_pads[] = {
 	IMX8MN_PAD_GPIO1_IO02__WDOG1_WDOG_B  | MUX_PAD_CTRL(WDOG_PAD_CTRL),
 };
 
+#if CONFIG_IS_ENABLED(EFI_HAVE_CAPSULE_SUPPORT)
+struct efi_fw_image fw_images[] = {
+       {
+               .image_type_id = IMX_BOOT_IMAGE_GUID,
+               .fw_name = u"IMX8MN-EVK-RAW",
+               .image_index = 1,
+       },
+};
+
+struct efi_capsule_update_info update_info = {
+       .dfu_string = "mmc 2=flash-bin raw 0 0x2000 mmcpart 1",
+       .images = fw_images,
+};
+
+u8 num_image_type_guids = ARRAY_SIZE(fw_images);
+#endif /* EFI_HAVE_CAPSULE_SUPPORT */
+
 int board_early_init_f(void)
 {
 	struct wdog_regs *wdog = (struct wdog_regs *)WDOG1_BASE_ADDR;
diff --git a/configs/imx8mn_var_som_defconfig b/configs/imx8mn_var_som_defconfig
index 2bee88194b4..17ca5adbd6f 100644
--- a/configs/imx8mn_var_som_defconfig
+++ b/configs/imx8mn_var_som_defconfig
@@ -49,7 +49,7 @@ CONFIG_SYS_PROMPT="u-boot=> "
 # CONFIG_CMD_IMPORTENV is not set
 CONFIG_CMD_ERASEENV=y
 CONFIG_CMD_NVEDIT_EFI=y
-# CONFIG_CMD_CRC32 is not set
+CONFIG_CRC32_VERIFY=y
 CONFIG_CMD_MEMTEST=y
 CONFIG_CMD_CLK=y
 CONFIG_CMD_DFU=y
diff --git a/include/configs/imx8mn_var_som.h b/include/configs/imx8mn_var_som.h
index 5cf49f528c4..69b10293a41 100644
--- a/include/configs/imx8mn_var_som.h
+++ b/include/configs/imx8mn_var_som.h
@@ -83,6 +83,7 @@
 	CONFIG_MFG_ENV_SETTINGS \
 	"bootdir=/boot\0" \
 	BOOTENV \
+	"prepare_mcore=setenv mcore_clk clk-imx8mn.mcore_booted;\0" \
 	"scriptaddr=0x43500000\0" \
 	"kernel_addr_r=" __stringify(CONFIG_SYS_LOAD_ADDR) "\0" \
 	"bsp_script=boot.scr\0" \
@@ -119,7 +120,7 @@
 		"fi; " \
 		"bootaux ${m7_addr};\0" \
 	"optargs=setenv bootargs ${bootargs} ${kernelargs};\0" \
-	"mmcargs=setenv bootargs console=${console} " \
+	"mmcargs=setenv bootargs ${mcore_clk} console=${console} " \
 		"root=/dev/mmcblk${mmcblk}p${mmcpart} rootwait rw ${cma_size} cma_name=linux,cma\0 " \
 	"loadbootscript=load mmc ${mmcdev}:${mmcpart} ${loadaddr} ${bootdir}/${bsp_script};\0" \
 	"bootscript=echo Running bootscript from mmc ...; " \
@@ -151,7 +152,7 @@
 		"else " \
 			"echo wait for boot; " \
 		"fi;\0" \
-	"netargs=setenv bootargs console=${console} " \
+	"netargs=setenv bootargs ${mcore_clk} console=${console} " \
 		"root=/dev/nfs ${cma_size} cma_name=linux,cma " \
 		"ip=dhcp nfsroot=${serverip}:${nfsroot},v3,tcp\0" \
 	"netboot=echo Booting from net ...; " \
-- 
2.34.1

